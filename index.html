<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>AI Quote Generator Pro - Bulk Social Media Content</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --bg-dark: #0a0e27;
  --bg-card: rgba(15, 23, 42, 0.8);
  --bg-card-hover: rgba(30, 41, 59, 0.9);
  --border: rgba(100, 116, 139, 0.2);
  --border-hover: rgba(148, 163, 184, 0.4);
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent-primary: #3b82f6;
  --accent-secondary: #8b5cf6;
  --accent-success: #10b981;
  --accent-warning: #f59e0b;
  --accent-error: #ef4444;
  --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  --gradient-5: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  --gradient-6: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.2);
  --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.3);
  --radius: 16px;
  --radius-sm: 8px;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-dark);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.1) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
  position: relative;
  z-index: 1;
}

/* Header */
.header {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 2rem;
  margin-bottom: 2rem;
  backdrop-filter: blur(20px);
  box-shadow: var(--shadow-lg);
}

.header-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 1.5rem;
}

.logo {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.logo-icon {
  width: 48px;
  height: 48px;
  background: var(--gradient-1);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}

.logo-text h1 {
  font-size: 1.75rem;
  font-weight: 800;
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 0.25rem;
}

.logo-text p {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.status-badge {
  padding: 0.5rem 1rem;
  border-radius: 99px;
  font-size: 0.875rem;
  font-weight: 600;
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.3);
  color: var(--accent-success);
}

/* Main Content */
.main-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 2rem;
}

/* Card Styles */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 2rem;
  backdrop-filter: blur(20px);
  box-shadow: var(--shadow-md);
  transition: all 0.3s ease;
}

.card:hover {
  border-color: var(--border-hover);
  box-shadow: var(--shadow-lg);
}

.card-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}

.card-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

.card-title {
  flex: 1;
}

.card-title h2 {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 0.25rem;
}

.card-title p {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

/* Form Elements */
.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 0.875rem 1rem;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 0.9375rem;
  transition: all 0.3s ease;
  font-family: inherit;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
}

.form-hint {
  font-size: 0.8125rem;
  color: var(--text-muted);
  margin-top: 0.5rem;
}

/* File Upload */
.file-upload {
  border: 2px dashed var(--border);
  border-radius: var(--radius-sm);
  padding: 2rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: rgba(15, 23, 42, 0.4);
}

.file-upload:hover {
  border-color: var(--accent-primary);
  background: rgba(59, 130, 246, 0.05);
}

.file-upload-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.file-upload-text {
  font-size: 0.9375rem;
  color: var(--text-secondary);
}

.file-upload input[type="file"] {
  display: none;
}

/* Design Style Grid */
.style-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.style-card {
  position: relative;
  padding: 1.5rem;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
  background: rgba(15, 23, 42, 0.6);
  overflow: hidden;
}

.style-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.style-card:hover {
  border-color: var(--border-hover);
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

.style-card.selected {
  border-color: var(--accent-primary);
  background: rgba(59, 130, 246, 0.1);
}

.style-card.selected::before {
  opacity: 1;
}

.style-card.style-gradient-blur::before {
  background: var(--gradient-1);
}

.style-card.style-dark-minimal::before {
  background: var(--gradient-6);
}

.style-card.style-vibrant-pop::before {
  background: var(--gradient-2);
}

.style-card.style-bold-geo::before {
  background: var(--gradient-5);
}

.style-card.style-glassmorphism::before {
  background: var(--gradient-3);
}

.style-card.style-abstract-art::before {
  background: var(--gradient-4);
}

.style-icon {
  font-size: 2.5rem;
  margin-bottom: 0.75rem;
}

.style-name {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text-primary);
}

.style-desc {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
}

/* Storage Options */
.storage-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.storage-option {
  padding: 1.5rem;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
  background: rgba(15, 23, 42, 0.6);
}

.storage-option:hover {
  border-color: var(--border-hover);
  transform: translateY(-4px);
}

.storage-option.selected {
  border-color: var(--accent-success);
  background: rgba(16, 185, 129, 0.1);
}

.storage-icon {
  font-size: 2rem;
  margin-bottom: 0.75rem;
}

.storage-name {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.storage-desc {
  font-size: 0.8125rem;
  color: var(--text-muted);
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.875rem 1.75rem;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 0.9375rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
}

.btn-primary {
  background: var(--gradient-1);
  color: white;
  box-shadow: var(--shadow-sm);
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-secondary {
  background: rgba(100, 116, 139, 0.2);
  color: var(--text-primary);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: rgba(100, 116, 139, 0.3);
  border-color: var(--border-hover);
}

.btn-full {
  width: 100%;
}

.btn-lg {
  padding: 1.125rem 2rem;
  font-size: 1.0625rem;
}

/* Progress Bar */
.progress-container {
  display: none;
  margin-top: 1.5rem;
}

.progress-container.active {
  display: block;
}

.progress-bar {
  height: 8px;
  background: rgba(100, 116, 139, 0.2);
  border-radius: 99px;
  overflow: hidden;
  margin-bottom: 0.75rem;
}

.progress-fill {
  height: 100%%;
  width: 0%%;
  background: var(--gradient-1);
  border-radius: 99px;
  transition: width 0.3s ease;
}

.progress-text {
  font-size: 0.875rem;
  color: var(--text-secondary);
  text-align: center;
}

/* Results Grid */
.results-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-top: 2rem;
}

.result-card {
  background: var(--bg-card-hover);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
  transition: all 0.3s ease;
}

.result-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
  border-color: var(--accent-primary);
}

.result-image {
  width: 100%%;
  aspect-ratio: 1;
  object-fit: cover;
  background: rgba(0, 0, 0, 0.2);
}

.result-info {
  padding: 1rem;
}

.result-quote {
  font-size: 0.875rem;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.result-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.8125rem;
  color: var(--text-muted);
}

.result-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.75rem;
}

.btn-icon {
  padding: 0.5rem;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 6px;
  color: var(--accent-primary);
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-icon:hover {
  background: rgba(59, 130, 246, 0.2);
  transform: scale(1.1);
}

/* Toast Notifications */
.toast {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 1rem 1.5rem;
  box-shadow: var(--shadow-lg);
  backdrop-filter: blur(20px);
  z-index: 1000;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.3s ease;
}

.toast.show {
  transform: translateY(0);
  opacity: 1;
}

.toast.success {
  border-left: 4px solid var(--accent-success);
}

.toast.error {
  border-left: 4px solid var(--accent-error);
}

.toast.warning {
  border-left: 4px solid var(--accent-warning);
}

/* Loading Spinner */
.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
  .container {
    padding: 1rem;
  }

  .header-content {
    flex-direction: column;
    align-items: flex-start;
  }

  .style-grid {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  }

  .storage-grid {
    grid-template-columns: 1fr;
  }

  .results-grid {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  }
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-top: 1.5rem;
}

.stat-card {
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: var(--radius-sm);
  padding: 1.5rem;
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  font-weight: 800;
  color: var(--accent-primary);
  margin-bottom: 0.25rem;
}

.stat-label {
  font-size: 0.8125rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.hidden {
  display: none !important;
}
</style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon">üé®</div>
          <div class="logo-text">
            <h1>AI Quote Generator Pro</h1>
            <p>Bulk Social Media Content Creator with AI</p>
          </div>
        </div>
        <div class="status-badge">
          ‚úì Ready to Generate
        </div>
      </div>
    </header>

    <div class="main-grid">
      <!-- Configuration Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon" style="background: var(--gradient-1);">‚öôÔ∏è</div>
          <div class="card-title">
            <h2>Configuration</h2>
            <p>Setup your bulk quote generation</p>
          </div>
        </div>

        <!-- Data Source -->
        <div class="form-group">
          <label class="form-label">Data Source</label>
          <select id="dataSource" class="form-select" onchange="selectDataSource(this.value)">
            <option value="google_sheets">Google Sheet (fixed from settings)</option>
          </select>
          <p class="form-hint">Google Sheet URL is loaded automatically from settings/.env</p>
        </div>

        <!-- Watermark/Signature -->
        <div class="form-group">
          <label class="form-label">Watermark / Signature</label>
          <select id="watermarkSelect" class="form-select"></select>
          <p class="form-hint">Select from your Watermarks folder (loaded automatically)</p>
        </div>

        <!-- Custom Logo/Watermark Upload (Optional Override) -->
        <div class="form-group">
          <label class="form-label">Custom Logo / Watermark Override (Optional)</label>
          <div class="file-upload" onclick="document.getElementById('logoInput').click()">
            <div class="file-upload-icon">üìÅ</div>
            <div class="file-upload-text" id="logoText">
              Click to upload logo (PNG recommended)
            </div>
            <input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(event)">
          </div>
        </div>
      </div>

      <!-- Design Style Selection -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon" style="background: var(--gradient-2);">üé®</div>
          <div class="card-title">
            <h2>Select Design Style</h2>
            <p>Choose one style for all generated images</p>
          </div>
        </div>

        <div class="style-grid">
          <div class="style-card style-gradient-blur" onclick="selectStyle('gradient-blur', this)">
            <div class="style-icon">üåÖ</div>
            <div class="style-name">Gradient Blur</div>
            <div class="style-desc">Soft & scenic</div>
          </div>

          <div class="style-card style-dark-minimal" onclick="selectStyle('dark-minimal', this)">
            <div class="style-icon">üåë</div>
            <div class="style-name">Dark Minimal</div>
            <div class="style-desc">Clean & modern</div>
          </div>

          <div class="style-card style-vibrant-pop" onclick="selectStyle('vibrant-pop', this)">
            <div class="style-icon">üéâ</div>
            <div class="style-name">Vibrant Pop</div>
            <div class="style-desc">Bold & energetic</div>
          </div>

          <div class="style-card style-bold-geo" onclick="selectStyle('bold-geo', this)">
            <div class="style-icon">üî∫</div>
            <div class="style-name">Bold Geometric</div>
            <div class="style-desc">Angular shapes</div>
          </div>

          <div class="style-card style-glassmorphism" onclick="selectStyle('glassmorphism', this)">
            <div class="style-icon">üíé</div>
            <div class="style-name">Glassmorphism</div>
            <div class="style-desc">Frosted glass</div>
          </div>

          <div class="style-card style-abstract-art" onclick="selectStyle('abstract-art', this)">
            <div class="style-icon">üé≠</div>
            <div class="style-name">Abstract Art</div>
            <div class="style-desc">Artistic vibe</div>
          </div>
        </div>
      </div>

      <!-- Storage Selection -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon" style="background: var(--gradient-3);">‚òÅÔ∏è</div>
          <div class="card-title">
            <h2>Storage Provider</h2>
            <p>Choose where to upload generated images</p>
          </div>
        </div>

        <div class="storage-grid">
          <div class="storage-option" onclick="selectStorage('imgbb', this)">
            <div class="storage-icon">üì∏</div>
            <div class="storage-name">ImgBB</div>
            <div class="storage-desc">Simple, no account needed</div>
          </div>

          <div class="storage-option" onclick="selectStorage('cloudinary', this)">
            <div class="storage-icon">‚òÅÔ∏è</div>
            <div class="storage-name">Cloudinary</div>
            <div class="storage-desc">Professional, reliable</div>
          </div>

          <div class="storage-option" onclick="selectStorage('gdrive', this)">
            <div class="storage-icon">üìÇ</div>
            <div class="storage-name">Google Drive</div>
            <div class="storage-desc">Direct to Drive</div>
          </div>

          <div class="storage-option" onclick="selectStorage('local', this)">
            <div class="storage-icon">üíæ</div>
            <div class="storage-name">Local</div>
            <div class="storage-desc">Keep files on this server</div>
          </div>
        </div>

        <!-- Storage Credentials -->
        <div id="apiKeySection" class="form-group hidden">
          <label class="form-label" id="apiKeyLabel">Storage Credentials</label>
          <input 
            type="text" 
            id="apiKey" 
            class="form-input" 
            placeholder="Optional (auto from settings/.env)"
          >
          <p class="form-hint" id="apiKeyHint">Leave empty to use settings/.env. Only fill if you want to override.</p>
        </div>
      </div>

      <!-- AI Configuration -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon" style="background: var(--gradient-4);">ü§ñ</div>
          <div class="card-title">
            <h2>AI Configuration</h2>
            <p>Select AI provider (defaults to Hugging Face from settings/.env)</p>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">AI Provider</label>
          <select id="aiProvider" class="form-select" onchange="selectAIProvider(this.value)">
            <option value="huggingface">Hugging Face</option>
          </select>
          <p class="form-hint">Provider API credentials are loaded automatically from settings/.env</p>
        </div>

        <div class="form-group" id="hfTokenSection">
          <label class="form-label">Hugging Face API Token (optional override)</label>
          <input 
            type="text" 
            id="hfToken" 
            class="form-input" 
            placeholder="Optional (auto from settings/.env)"
          >
          <p class="form-hint">Leave empty to use HUGGINGFACE_API_TOKEN / HF_API_TOKEN</p>
        </div>

        <div class="form-group">
          <label class="form-label">Text-to-Prompt Model</label>
          <select id="promptModel" class="form-select">
            <option value="meta-llama/Llama-3.2-3B-Instruct">Llama 3.2 3B (Fast)</option>
            <option value="mistralai/Mistral-7B-Instruct-v0.3">Mistral 7B (Balanced)</option>
            <option value="HuggingFaceH4/zephyr-7b-beta">Zephyr 7B (Quality)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Image Generation Model</label>
          <select id="imageModel" class="form-select">
            <option value="stabilityai/stable-diffusion-xl-base-1.0">SDXL 1.0 (Best Quality)</option>
            <option value="runwayml/stable-diffusion-v1-5">SD 1.5 (Fast)</option>
            <option value="segmind/SSD-1B">SSD-1B (Fastest)</option>
          </select>
        </div>
      </div>

      <!-- Generate Button -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon" style="background: var(--gradient-5);">üöÄ</div>
          <div class="card-title">
            <h2>Start Generation</h2>
            <p>Process all quotes from your sheet</p>
          </div>
        </div>

        <button id="generateBtn" class="btn btn-primary btn-full btn-lg" onclick="startBulkGeneration()">
          <span>üé®</span>
          <span>Generate All Quotes</span>
        </button>

        <!-- Progress -->
        <div id="progressContainer" class="progress-container">
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
          </div>
          <div id="progressText" class="progress-text">Initializing...</div>
        </div>

        <!-- Stats -->
        <div id="statsContainer" class="stats-grid hidden">
          <div class="stat-card">
            <div class="stat-value" id="statProcessed">0</div>
            <div class="stat-label">Processed</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statSuccess">0</div>
            <div class="stat-label">Success</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statFailed">0</div>
            <div class="stat-label">Failed</div>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div id="resultsSection" class="card hidden">
        <div class="card-header">
          <div class="card-icon" style="background: var(--gradient-6);">üìä</div>
          <div class="card-title">
            <h2>Generated Images</h2>
            <p>Preview and download your images</p>
          </div>
        </div>

        <div id="resultsGrid" class="results-grid"></div>

        <button class="btn btn-secondary btn-full" onclick="downloadAllImages()">
          <span>‚¨áÔ∏è</span>
          <span>Download All Images (ZIP)</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Global state
    let selectedStyle = null;
    let selectedStorage = null;
    let selectedDataSource = 'google_sheets';
    let selectedAIProvider = 'huggingface';
    let uploadedLogo = null;
    let generatedImages = [];
    let appSettings = null;

    // Style selection
    function selectStyle(style, element) {
      selectedStyle = style;
      document.querySelectorAll('.style-card').forEach(card => {
        card.classList.remove('selected');
      });
      element.classList.add('selected');
      showToast('Style selected: ' + style, 'success');
    }

    function selectDataSource(ds) {
      selectedDataSource = ds || 'google_sheets';
    }

    function selectAIProvider(p) {
      selectedAIProvider = p || 'huggingface';
    }

    async function loadAppSettings() {
      try {
        const d = await fetch('/api/settings').then(r => r.json());
        if (d && d.ok) {
          appSettings = d;

          // Watermarks
          const wm = document.getElementById('watermarkSelect');
          if (wm) {
            const opts = (d.watermark_options || []);
            wm.innerHTML = '';
            const o0 = document.createElement('option');
            o0.value = '';
            o0.textContent = 'None';
            wm.appendChild(o0);
            opts.forEach(name => {
              const o = document.createElement('option');
              o.value = name;
              o.textContent = name;
              wm.appendChild(o);
            });
            if (d.default_watermark) wm.value = d.default_watermark;
          }

          // preselect defaults
          if (d.default_storage_provider) {
            const el = document.querySelector(`.storage-option[onclick*="'${d.default_storage_provider}'"]`);
            if (el) selectStorage(d.default_storage_provider, el);
          }

          // AI Provider default
          if (d.default_ai_provider) {
            const ai = document.getElementById('aiProvider');
            if (ai) ai.value = d.default_ai_provider;
            selectAIProvider(d.default_ai_provider);
          }
        }
      } catch (e) {
        // ignore
      }
    }

    // Storage selection
    function selectStorage(storage, element) {
      selectedStorage = storage;
      document.querySelectorAll('.storage-option').forEach(option => {
        option.classList.remove('selected');
      });
      element.classList.add('selected');

      // Show credentials override only for providers that need secrets
      const apiKeySection = document.getElementById('apiKeySection');
      const apiKeyLabel = document.getElementById('apiKeyLabel');
      const apiKeyHint = document.getElementById('apiKeyHint');

      if (storage === 'local') {
        apiKeySection.classList.add('hidden');
      } else {
        apiKeySection.classList.remove('hidden');
      }

      if (storage === 'imgbb') {
        apiKeyLabel.textContent = 'ImgBB API Key (optional override)';
        apiKeyHint.textContent = 'Leave empty to use IMGBB_API_KEY from settings/.env';
      } else if (storage === 'cloudinary') {
        apiKeyLabel.textContent = 'Cloudinary Credentials (optional override)';
        apiKeyHint.textContent = 'Leave empty to use CLOUDINARY_CREDENTIALS from settings/.env';
      } else if (storage === 'gdrive') {
        apiKeyLabel.textContent = 'Google Drive Credentials Path (optional override)';
        apiKeyHint.textContent = 'Leave empty to use GOOGLE_DRIVE_CREDENTIALS_PATH or credentials.json';
      }

      showToast('Storage selected: ' + storage, 'success');
    }

    // Handle logo upload
    function handleLogoUpload(event) {
      const file = event.target.files[0];
      if (file) {
        uploadedLogo = file;
        document.getElementById('logoText').textContent = `‚úì ${file.name}`;
        showToast('Logo uploaded successfully', 'success');
      }
    }

    // Start bulk generation
    async function startBulkGeneration() {
      // Validation
      const hfToken = (document.getElementById('hfToken') ? document.getElementById('hfToken').value.trim() : '');
      const apiKey = (document.getElementById('apiKey') ? document.getElementById('apiKey').value.trim() : '');

      if (!selectedStyle) {
        showToast('Please select a design style', 'error');
        return;
      }

      if (!selectedStorage) {
        showToast('Please select a storage provider', 'error');
        return;
      }

      // hfToken/apiKey are optional overrides now; backend loads from settings/.env

      // Disable button
      const btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div><span>Processing...</span>';

      // Show progress
      document.getElementById('progressContainer').classList.add('active');
      document.getElementById('statsContainer').classList.remove('hidden');

      // Prepare payload
      const payload = {
        data_source: selectedDataSource,
        ai_provider: selectedAIProvider,
        design_style: selectedStyle,
        storage_provider: selectedStorage,
        storage_api_key: apiKey || null,
        hf_token: hfToken || null,
        prompt_model: document.getElementById('promptModel').value,
        image_model: document.getElementById('imageModel').value,
        watermark_file: (document.getElementById('watermarkSelect') ? document.getElementById('watermarkSelect').value : '') || null,
        logo: uploadedLogo ? await fileToBase64(uploadedLogo) : null
      };

      try {
        // Send to backend
        const response = await fetch('/api/bulk-generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (data.success) {
          // Poll for progress
          pollProgress(data.job_id);
        } else {
          throw new Error(data.error || 'Generation failed');
        }
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
        resetUI();
      }
    }

    // Poll job progress
    async function pollProgress(jobId) {
      const interval = setInterval(async () => {
        try {
          const response = await fetch(`/api/job-status/${jobId}`);
          const data = await response.json();

          // Update progress
          updateProgress(data.progress, data.message);
          updateStats(data.processed, data.success, data.failed);

          if (data.status === 'completed') {
            clearInterval(interval);
            handleCompletion(data.results);
          } else if (data.status === 'failed') {
            clearInterval(interval);
            showToast('Generation failed: ' + data.error, 'error');
            resetUI();
          }
        } catch (error) {
          clearInterval(interval);
          showToast('Error checking status', 'error');
          resetUI();
        }
      }, 1000);
    }

    // Update progress bar
    function updateProgress(percent, message) {
      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('progressText').textContent = message;
    }

    // Update stats
    function updateStats(processed, success, failed) {
      document.getElementById('statProcessed').textContent = processed;
      document.getElementById('statSuccess').textContent = success;
      document.getElementById('statFailed').textContent = failed;
    }

    // Handle completion
    function handleCompletion(results) {
      generatedImages = results;
      
      // Show results section
      document.getElementById('resultsSection').classList.remove('hidden');
      
      // Render results
      const grid = document.getElementById('resultsGrid');
      grid.innerHTML = results.map((result, index) => `
        <div class="result-card">
          <img src="${result.image_url}" alt="Quote ${index + 1}" class="result-image">
          <div class="result-info">
            <div class="result-quote">"${result.quote.substring(0, 80)}..."</div>
            <div class="result-meta">
              <span>${result.author}</span>
              <span>${result.style}</span>
            </div>
            <div class="result-actions">
              <button class="btn-icon" onclick="window.open('${result.image_url}', '_blank')" title="View">
                üîç
              </button>
              <button class="btn-icon" onclick="downloadImage('${result.image_url}', 'quote-${index + 1}.png')" title="Download">
                ‚¨áÔ∏è
              </button>
              <button class="btn-icon" onclick="copyLink('${result.image_url}')" title="Copy Link">
                üîó
              </button>
            </div>
          </div>
        </div>
      `).join('');

      showToast('‚ú® Generation completed! ' + results.length + ' images created', 'success');
      resetUI();
    }

    // Reset UI
    function resetUI() {
      const btn = document.getElementById('generateBtn');
      btn.disabled = false;
      btn.innerHTML = '<span>üé®</span><span>Generate All Quotes</span>';
    }

    // Download single image
    async function downloadImage(url, filename) {
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        showToast('Image downloaded', 'success');
      } catch (error) {
        showToast('Download failed', 'error');
      }
    }

    // Download all images as ZIP
    async function downloadAllImages() {
      showToast('Preparing ZIP file...', 'warning');
      try {
        const response = await fetch('/api/download-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ images: generatedImages })
        });
        
        const blob = await response.blob();
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'quotes-' + Date.now() + '.zip';
        link.click();
        showToast('All images downloaded', 'success');
      } catch (error) {
        showToast('Download failed', 'error');
      }
    }

    // Copy link to clipboard
    function copyLink(url) {
      navigator.clipboard.writeText(url).then(() => {
        showToast('Link copied to clipboard', 'success');
      }).catch(() => {
        showToast('Failed to copy link', 'error');
      });
    }

    // File to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      console.log('AI Quote Generator Pro initialized');
      loadAppSettings();
    });
  </script>
</body>
</html>
